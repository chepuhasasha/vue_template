# Правила разработки и качества кода

[← Назад к корневому README](README.md)

Цель этого документа - обеспечить устойчивое качество кода, воспроизводимость решений и единые подходы к тестированию и документации. Следуйте правилам **обязательно**.

## Рабочий процесс

1. Возьмите задачу в Jira с ключом (например, `FRONT-001`).
2. Создайте ветку **от `develop`** и назовите **точно как ключ задачи**.
3. Реализуйте изменения, соблюдая разделы [Именование и соглашения](#именование-и-соглашения), [Качество кода](#качество-кода), [Архитектура](#архитектура-и-границы-ответственности), [Состояние](#работа-с-состоянием-pinia), [API](#работа-с-api).
4. Обновите документацию согласно разделу [Документация](#документация).
5. Обновите релизные заметки в `public/releases/unreleased.json` (регламент: [CHANGELOG.md](CHANGELOG.md)).
6. Обновите тесты и документацию по тестам согласно разделу [Тестирование](#тестирование).
7. Если нужен временный компромисс, оформите техдолг по правилам [Техдолг](#техдолг).
8. Делайте коммиты по правилам [Коммиты и PR](#коммиты-и-pr).
9. Перед PR синхронизируйтесь с `develop` через rebase, выполните `npm run precommit` и пройдите чеклист из разделов [Ревью](#ревью) и [Локальные проверки перед PR](#локальные-проверки-перед-pr).

## Именование и соглашения

### Файлы и папки

- **Компоненты**: `PascalCase.vue` (например, `UserCard.vue`).
- **Композиции**: `useXxx.ts` (например, `useTheme.ts`).
- **Утилиты**: `camelCase.ts`.
- **Тесты**: `ComponentName.spec.ts` или `useXxx.spec.ts`.
- **Страницы**: `src/views/<Page>/View.vue` (каждая страница — отдельная папка).

Все, что относится **только** к странице, хранится внутри ее папки. Общие части выносите в `src/components`, `src/composables`, `src/utils`.

Пример структуры страницы:

```
src/views/Profile/
  View.vue
  components/
  composables/
  types/
  assets/
```

### Переменные и функции

- `camelCase` для переменных и функций.
- Константы: `UPPER_SNAKE_CASE`.
- Избегайте сокращений, кроме общепринятых (`id`, `url`).

### Верстка (BEM)

- Вся верстка оформляется по методологии BEM.
- Блок — корневой класс компонента или страницы: `block-name`.
- Элементы блока: `block-name__element`.
- Модификаторы: `block-name--modifier`.
- Не используйте один и тот же блок с разными стилями в разных компонентах — это разные блоки либо модификаторы.
- Для стилизации используйте классы; исключения допустимы только для глобальных базовых правил (reset/typography/scrollbar) и служебных классов фреймворков (например, `router-link-active`, `*-enter-active` для Vue transitions).

## Документация

> Каждое изменение **должно** сопровождаться документацией, добавьте описание в соответствующий файл документации.

### JSDoc

Для каждой новой функции/метода пишите JSDoc.

Пример:

```ts
/**
 * Форматирует отображаемое имя пользователя.
 * @param firstName Имя пользователя.
 * @param lastName Фамилия пользователя.
 * @returns Полное имя, собранное через пробел.
 */
export const formatUserName = (firstName: string, lastName: string): string => {
  return `${firstName} ${lastName}`
}
```

## Техдолг

Используйте только ключевые слова в комментариях:

- `TODO` — общий техдолг.
- `FIXME` — баг/ошибка, требующая исправления.
- `BUG` — подтверждённый баг.
- `HACK` — временное/грязное решение.
- `OPTIMIZE` — нужна оптимизация.
- `NOTE` — важная пометка.

Обязательный формат записи (одна строка):

```
// TODO: [YYYY-MM-DD] <описание> <риск> <план> (ссылка/задача)
```

Пример в коде:

```ts
// HACK: [2026-02-06] временно выставляем z-index=9999 для перекрытия модалки; возможен конфликт слоев; нужно ввести слойную систему, задача #FRONT-001.
```

Где размещать:

- Рядом с проблемным местом в коде.
- Если проблема архитектурная - в ключевом файле `main.ts`.

Когда техдолг устранён:

- Удалите строку с ключевым словом из кода.
 - При необходимости оставьте обычный комментарий без ключевых слов и/или отметьте изменение в `public/releases/unreleased.json`.

## Тестирование

Документация по тестам (источник истины): [Тесты](tests/README.md)

Минимальные требования:

- **Новая функциональность** = **новые тесты**.
- **Исправление бага** = **тест, который воспроизводит баг**.
- **Новый тест или группа тестов** = **обновление документации по тестам** (`tests/README.md` или README соответствующего раздела).

## Качество кода

### Общие правила

- Следуйте настройкам `ESLint`, `Stylelint`, `Prettier`.
- Не отключайте правила линтера для обхода ошибок.
- Избегайте чисел - используйте именованные константы.
- Разбивайте сложные участки на мелкие функции.

### Тестовые идентификаторы (`v-testid`)

- Использование `v-testid` **обязательно** для всей верстки (каждый элемент должен иметь `data-testid`).
- В тестах основной селектор — `data-testid`, другие селекторы используйте только в крайних случаях.
- Не используйте `testid`-пропы или прямой `data-testid` — идентификаторы формируются через `v-testid`.
- Идентификаторы должны быть стабильными и предсказуемыми: используйте осмысленные значения, избегайте случайных чисел.
- Предпочитайте объектную форму, если нужен префикс или суффикс.

#### Динамическая верстка

**`v-if` / `v-else` / `v-else-if`:**

- У каждой ветки должен быть свой `v-testid`, чтобы тесты однозначно различали состояния.
- Тестовые id могут совпадать по базовой части, но должны отличаться по `suffix`.

```pug
div(
  v-if="isLoading"
  v-testid="{ id: 'profile', suffix: 'loading' }")
div(
  v-else
  v-testid="{ id: 'profile', suffix: 'ready' }")
```

**`v-for`:**

- Каждый элемент списка обязан иметь уникальный `data-testid`.
- Добавляйте уникальную часть через `suffix` (например, `id` записи или индекс, если другого нет).

```pug
li(
  v-for="(item, index) in items"
  :key="item.id"
  v-testid="{ id: 'user-row', suffix: item.id ?? String(index) }") {{ item.name }}
```

## Архитектура и границы ответственности

- Логика не должна быть в шаблоне компонента - выносите в `setup` и `composables`.
- Компоненты UI не должны знать о бизнес-логике.
- `views/` могут объединять UI и бизнес-логику через композиции.

## Работа с состоянием (Pinia)

- Состояние группируется по доменам.
- Не храните в состоянии то, что можно вычислить (`computed`).
- В сторе описывайте `state`, `getters`, `actions`.
- Внешние сервисы (API) используйте через отдельные слои (например, `services/`).

## Работа с API

- Все запросы должны быть вынесены в отдельные модули.
- Ошибки обрабатываются централизованно.
- Для моделей данных используйте типы или интерфейсы.

## Коммиты и PR

| Этап          | Правило                                                                                                                                                                                    |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Задача        | Возьмите задачу в Jira (например, `FRONT-001`).                                                                                                                                            |
| Ветка         | Создайте ветку **от `develop`** и назовите **точно как ключ задачи** (`FRONT-001`).                                                                                                        |
| Коммиты       | Один логический коммит = одно изменение. Сообщение должно описывать цель. Формат: `#FRONT-001 <type>: <message>`, где `<type>` один из `feat`, `fix`, `chore`, `refactor`, `test`, `docs`. |
| PR            | Только через PR, прямые пуши в `develop` запрещены. Один PR = одна задача.                                                                                                                 |
| Синхронизация | Перед PR обновляйте ветку от `develop` через `rebase`.                                                                                                                                     |

Пример:

```
#FRONT-001 feat: add documentation rules for new components
```

## Ревью

Перед отправкой PR убедитесь, что:

1. код покрыт тестами;
2. документация обновлена;
3. форматирование и линтинг пройдены.

## Локальные проверки перед PR

Всегда выполняйте:

```bash
npm run format
npm run lint
npm run test
```

или

```bash
npm run precommit
```
