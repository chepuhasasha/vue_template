# Тесты

[← Назад к корневому README](../README.md)

Документация по тестам проекта: подход, структура, запуск и общие правила.

- [Тесты компонентов](components/README.md)
- [Тесты композиций](composables/README.md)
- [Тесты плагинов](plugins/README.md)

## Инструменты

- `Vitest` как тест-раннер.
- `@testing-library/vue` для поведенческих тестов UI.
- `@vue/test-utils` для низкоуровневых проверок.
- `jsdom` как среда выполнения.
- `@testing-library/jest-dom` для DOM-матчеров.

## Содержимое

- `setup.ts` — глобальная настройка окружения тестов.
- `components/` — тесты компонентов.
- `composables/` — тесты композиций.
- `plugins/` — тесты плагинов и директив.

## Запуск

- `npm run test` — запуск всех тестов с покрытием.
- HTML-отчет по покрытию: `coverage/index.html`.

## Покрытие

Минимальные уровни покрытия (цели проекта):

| Метрика    | Минимум |
| ---------- | ------- |
| Statements | 80%     |
| Branches   | 70%     |
| Functions  | 80%     |
| Lines      | 80%     |

Порог проверяется автоматически при `npm run test` **для каждого файла** (суммарный по проекту не используется) и падает в `npm run precommit`, если минимумы не достигнуты.

Пример ошибки:

```bash
ERROR: Coverage for statements (82.22%) does not meet global threshold (100%) for src/plugins/testId.ts
```

Если пороги не достигнуты — **не коммитить** изменения до исправления. **Не понижать** пороги ради прохождения проверок.

Примечание: формулировка `global threshold` в ошибке означает базовые минимумы из `vitest.config.ts`, которые применяются к **каждому файлу**.

## Глобальная настройка (`tests/setup.ts`)

- Подключает DOM-матчеры из `@testing-library/jest-dom`.
- Делает `cleanup()` после каждого теста.
- Мокает `axios` и его методы.
- Стабит `window.alert`.

## Пути и алиасы

- `@` указывает на `src/` (можно использовать в импортах тестов).

## Правила и соглашения

- Имя файла теста: `*.spec.ts`.
- Тесты должны читаться без знания реализации.
- Каждый тест проверяет одно поведение.
- В тестах основной селектор — `data-testid` (через `v-testid`), другие селекторы используйте только в крайних случаях.
- Не задавайте `data-testid` напрямую или через пропсы — используйте `v-testid`.
- Не опирайтесь на порядок выполнения тестов, изолируйте состояние.
- Если используется глобальный префикс `VITE_TEST_ID_PREFIX`, собирайте `data-testid` через `buildTestId` из `src/plugins/testId`.

## Пример структуры теста

```ts
import { describe, it, expect } from 'vitest'

describe('feature', () => {
  it('делает X при Y', () => {
    // arrange
    // act
    // assert
  })
})
```

## Моки и окружение

- `axios` уже замокан глобально. Настраивайте ответы через `vi.mocked(axios)` или `axios.get.mockResolvedValue(...)`.
- Для таймеров используйте `vi.useFakeTimers()` и возвращайте `vi.useRealTimers()` в `afterEach`.
